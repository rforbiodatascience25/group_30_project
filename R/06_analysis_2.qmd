---
title: "06_analysis_2"
format: html
---

```{r}
library(tidyverse)
```

# Analysis of Fmax in SAA Projects 155 and 237

This analysis focuses on the two SAA projects, 155 and 237. Each project measured fluorescence in three replicates per sample.

Variations in assay duration, cycle length, and reaction mixture composition mean that fluorescence values (Fmax) are not directly comparable across projects without normalization.

## Fmax Means Between Projects

Although we only consider mean Fmax values, there is a big difference. Project 237 consistently shows higher Fmax mean than Project 155. This is expected due to the shorter 24-hour assay, which produces higher fluorescence levels compared to the longer 150-hour assay of Project 155.

```{r}
saa_data_aug |> 
  ggplot(aes(project, fmax_mean)) + 
  geom_violin() + 
  geom_boxplot(width = 0.1)
```

# Replicate Consistency

Means alone can't compare the two projects, and to make a comparison and assessment on their precision, we will look at whether replicate measurements (rep 1–3) are consistent within each project

```{r}
ggplot(saa_data_aug, aes(x = factor(rep), y = fmax, color = project)) +
  geom_boxplot() +
  facet_wrap(~ project) +
  labs(x = "Repeat", y = "Fmax")

```

```{r}
repeats_stat <- saa_data_aug |> 
  ungroup() |> 
  summarize(mean=mean(fmax), 
            median=median(fmax),
            IQR = quantile(fmax,.75)- quantile(fmax,.25),
            .by = c(project, rep))
```

|                  | 155      | 237      |
|------------------|----------|----------|
| **rep 1 median** | 72926    | 142138   |
| **rep 2 median** | 70262    | 135570   |
| **rep 3 median** | 69721    | 137200   |
| **Variation**    | **3205** | **6568** |

Observations:

-   Project 155: Replicates show a gradual decline from rep 1 to rep 3

-   Project 237: Rep 1 and rep 3 are slightly higher than rep 2.

Replicates are not identical but follow a pattern that is project-dependent, reflecting assay protocol characteristics.

|               | 155       | 237         |
|---------------|-----------|-------------|
| **rep 1 IQR** | 69735.50  | 59529.75    |
| **rep 2 IQR** | 69404.25  | 63909.50    |
| **rep 3 IQR** | 82973.25  | 63178.50    |
| **Variation** | **13569** | **4379.75** |

-   Project 155: IQR \~69–82k, showing higher variability (VARIATION?)

-   Projekt 237: IQR \@\~59–64k, showing more consistent replicates\

**Project 237 is therefore more consistent between replicates than Project 155.**

## Replicate Standard Deviation

Standard deviation (SD) of Fmax across replicates measures internal stability of the assay.

```{r}
sd_saa_data <- saa_data_aug |> 
  group_by(patient_number, rundate) |> 
  mutate(fmax_sd = sd(fmax))
```

```{r}
sd_saa_data |> 
  filter(instrument == 2 | instrument == 4 | instrument == 6) |> 
  ggplot(aes(x = project, y = fmax_sd)) +
  geom_boxplot() +
  labs(x = "project", y = "sd fmax")
```

```{r}
sd_saa_data |>
  ungroup() |> 
  summarize(min = min(fmax_sd), 
            mean=mean(fmax_sd), 
            median=median(fmax_sd), 
            max=max(fmax_sd),
            IQR = quantile(fmax_sd,.75)- quantile(fmax_sd,.25),
             .by = project)
```

Analysis of replicate SDs shows a striking difference:

|            | 155       | 237      |
|------------|-----------|----------|
| **mean**   | 24065.55  | 10386.01 |
| **median** | 22198.389 | 5662.369 |
| **IQR**    | 26131.171 | 6469.984 |

The 150-hour assay (Project 155) has 2-4 times higher replicate variability, indicating lower measurement precision than the 24-hour assay (Project 237). This is a central quality finding.

## Instrument-Specific Variability

We examined whether instruments contribute to observed variability.

```{r}
sd_saa_data |> 
  filter(instrument == 2 | instrument == 4 | instrument == 6) |> 
  ggplot(aes(x = instrument, y = fmax_sd, color = instrument)) +
  facet_wrap( ~ project) +
  geom_boxplot() +
  labs(x = "instrument", y = "sd fmax") 
```

```{r}
sd_instruments_stats <- sd_saa_data |> 
  ungroup() |> 
  filter(rep == 1) |> 
  summarize(mean=mean(fmax_sd), 
            median=median(fmax_sd), 
            IQR = quantile(fmax_sd,.75)- quantile(fmax_sd,.25),
             .by = c(project, instrument))
```

|     | **instrument** | **mean**  | **median** | **IQR**   |
|:----|:---------------|:----------|:-----------|:----------|
| 155 | 2              | 30015.228 | 28998.572  | 30174.425 |
| 155 | 4              | 21468.795 | 20742.746  | 21745.751 |
| 155 | 6              | 20189.626 | 17562.292  | 24950.167 |
| 237 | 6              | 13107.043 | 8356.858   | 6809.040  |
| 237 | 2              | 8384.049  | 4482.218   | 4952.750  |
| 237 | 4              | 8788.222  | 4594.309   | 5483.490  |

-   Project 155: instrument 2 shows highest SD (\~30k), instrument 6 lowest (\~20k)

-   Project 237: instrument 6 shows highest SD (\~13k), instrument 2 lowest (\~8.4k)

There is no global instrument trend; variability depends on the combination of project and instrument. Importantly, even the “worst” instrument in Project 237 has lower SD than Project 155. This confirms that assay protocol is the dominant source of variability.

## Raw Fmax Across Instruments and Replicates

```{r}
saa_data_aug |> 
  filter(instrument == 2 | instrument == 4 | instrument == 6) |> 
  ggplot(aes(x = factor(rep), y = fmax, color = factor(instrument))) +
  facet_grid(instrument ~ project) +
  geom_boxplot() +
  labs(x = "Repeat", y = "Fmax")

```

```{r}
stats_instruments_project <- saa_data_aug |>
  ungroup() |> 
  filter(instrument == 2 | instrument == 4 | instrument == 6) |> 
  summarize(min = min(fmax), 
            mean=mean(fmax), 
            median=median(fmax), 
            max=max(fmax),
             .by = c(project, rep, instrument))

stats_instruments_project
```

For both projects, either rep 1 or rep 3 typically has the highest Fmax, with rep 2 lower. This is common in real-time aggregation assays: rep 1 “primes” the system, and rep 3 stabilizes the measurement curve. Replicates follow reproducible internal technical patterns, which are stable within a project and instrument.

### Instrument 2

|                 | 155     | 237      |
|-----------------|---------|----------|
| Median (rep 1)  | 93781.0 | 137402.5 |
| Median (rep 2)  | 86402.0 | 133614.0 |
| Median (rep 3)  | 81850.0 | 134146.0 |

### Instrument 4

|                 | 155     | 237      |
|-----------------|---------|----------|
| Median (rep 1)  | 66598.0 | 132876.0 |
| Median (rep 2)  | 65894.5 | 130309.5 |
| Median (rep 3)  | 66471.0 | 132749.0 |

### instrument 6

|                 | 155     | 237      |
|-----------------|---------|----------|
| Median (rep 1)  | 63126.0 | 158205.0 |
| Median (rep 2)  | 56437.0 | 143678.0 |
| Median (rep 3)  | 63862.0 | 141988.0 |

## Summary and Interpretation

Across all analyses - mean Fmax, replicate structure, SD, and instrument comparison - Project 237 consistently shows:

-   Higher Fmax values

-   Significantly lower replicate variability

-   More stable and reproducible replicates

Project 155, using the 150-hour assay, displays 2–4× higher replicate SD, indicating lower measurement precision. Instrument effects are minor compared to the protocol-driven differences. Repeats exhibit characteristic patterns, but overall stability is superior in Project 237. These findings highlight that assay protocol, rather than instrument, is the dominant factor influencing Fmax measurements.
