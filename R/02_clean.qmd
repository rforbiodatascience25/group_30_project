---
title: "02_clean"
format: html
---

```{r}
library(tidyverse)
```

# Loading the raw data

```{r}
raw_data <- read_tsv("../data/01_dat_load.tsv")
raw_data |> 
  slice_sample(n = 10)
```

# Clean the data

## Deleting columns

Some columns in the data-set are not part of the chosen analytic points. The columns chosen to omit is at the cause are either:

-   Irrelevant to the analysis such as the name of the institution or the responsible practitioner.

-   Contain the same value for all observation such as the TYPE (which is always a cerebrospinal fluid sample) and SAAMethod (results always made on the basis of a SAA).

-   Only have a value in observed in one of the projects: SAA_Type, TSmax, T50.

-   Lack meassurements for most observations like SampleVolume.

```{r}
# Neglecting the unused columns:
tidy_data <- raw_data |>
  select(-"COHORT",
         -"PI_NAME",
         -"PI_INSTITUTION",
         -"TYPE",
         -"SAAMethod",
         -"SAA_Type",
         -starts_with("TSmax"),
         -starts_with("SLOPE"),
         -starts_with("T50"),
         -starts_with("Sample"))


## titel ift at data skrives l√¶ngere

#we want the fmax ttt and auc to have three columns instead of having 6 columns.

tidy_data <- tidy_data |> 
  pivot_longer(
    cols = matches("Fmax|TTT|AUC"), 
    names_to = c("measurement", "duration", "rep"), 
    names_pattern = ("(Fmax|TTT|AUC)_(\\d+)h_Rep(\\d+)"),
    values_to = "value",
    values_drop_na = TRUE
  ) |> 
  pivot_wider(
    names_from = measurement,
    values_from = value
  )
tidy_data |> 
  slice_sample(n = 10)
```

## checking the instrument

```{r}
all(tidy_data$InstrumentRep1 == tidy_data$InstrumentRep2 & tidy_data$InstrumentRep2 == tidy_data$InstrumentRep3)

```

```{r}
tidy_data <- tidy_data |> 
  select(!InstrumentRep2 & !InstrumentRep3) |> 
  rename(instrument = InstrumentRep1)
```

## renaming

```{r}
tidy_data <- tidy_data |>
  rename(
    patient_number = PATNO,
    sex = SEX,
    project = PROJECTID,
    clinical_event = CLINICAL_EVENT,
    saa_result = SAA_Status,
    rundate = RUNDATE,
    fmax = Fmax,
    ttt = TTT,
    auc = AUC)
```

## laver til anden type

```{r}
tidy_data <- tidy_data |>
  mutate(across(c(project, 
                  duration, 
                  rep, 
                  instrument), 
                
                as.character))

```

## relocating

```{r}
tidy_data <- tidy_data |>
	relocate(project)

tidy_data <- tidy_data |>
	relocate(duration:auc, .after = saa_result)

```

## Arrange

```{r}
tidy_data <- tidy_data |>
  arrange(patient_number, saa_result)
```

# Save the cleaned data

```{r}
write_tsv(tidy_data, "../data/02_dat_clean.tsv")
```
