---
title: "02_clean"
format: html
---

```{r}
library(tidyverse)
library(readr)
library(dplyr)
```

# Loading the raw data

```{r}
raw_data <- read_tsv("../data/01_dat_load.tsv")
```

# Clean the data

## Deleting columns

There is some columns that aren't relevant for us, such as the name of the institution and *PI?* . Some of the columns have the same value through the whole dataset, such as TYPE (rygmarvsprøve) and SAAMethod.

There is also some columns that are only measured in one of the projects, and not both. We also want to delete those. SAA_Type, TSmax, T50.

Also there are some columns that almost has no measurements, that is the sample volume.

```{r}
tidy_data <- raw_data |>
  select(-"COHORT",
         -"PI_NAME",
         -"PI_INSTITUTION",
         -"TYPE",
         -"SAAMethod",
         -"SAA_Type",
         -starts_with("TSmax"),
         -starts_with("SLOPE"),
         -starts_with("T50"),
         -starts_with("Sample"))


## titel ift at data skrives længere

#we want the fmax ttt and auc to have three columns instead of having 6 columns.

tidy_data <- tidy_data |> 
  pivot_longer(
    cols = matches("Fmax|TTT|AUC"), 
    names_to = c("measurement", "duration", "rep"), 
    names_pattern = ("(Fmax|TTT|AUC)_(\\d+)h_Rep(\\d+)"),
    values_to = "value",
    values_drop_na = TRUE
  ) |> 
  pivot_wider(
    names_from = measurement,
    values_from = value
  )
```

## checking the instrument

```{r}
all(tidy_data$InstrumentRep1 == tidy_data$InstrumentRep2 & tidy_data$InstrumentRep2 == tidy_data$InstrumentRep3)

```

```{r}
tidy_data <- tidy_data |> 
  select(!InstrumentRep2 & !InstrumentRep3) |> 
  rename(instrument = InstrumentRep1)
```

## renaming

```{r}
tidy_data <- tidy_data |>
  rename(
    patient_number = PATNO,
    sex = SEX,
    project = PROJECTID,
    clinical_event = CLINICAL_EVENT,
    saa_result = SAA_Status,
    rundate = RUNDATE,
    fmax = Fmax,
    ttt = TTT,
    auc = AUC)
```

## laver til anden type

```{r}
tidy_data <- tidy_data |>
  mutate(across(c(project, 
                  duration, 
                  rep, 
                  instrument), 
                
                as.character))

```

## relocating

```{r}
tidy_data <- tidy_data |>
	relocate(project)

tidy_data <- tidy_data |>
	relocate(duration:auc, .after = saa_result)

```

## Arrange

```{r}
tidy_data <- tidy_data |>
  arrange(patient_number, saa_result)
```

# Save the cleaned data

```{r}
write_tsv(tidy_data, "../data/02_dat_clean.tsv")
```
