---
title: "03_augment"
format: html
---

```{r}
library(tidyverse)
```

# Loading the clean data

```{r}
tidy_data <- read_tsv("../data/02_dat_clean.tsv")
```

# Augment Data

## Calculating means of Fmax, ttt and auc

Instead of working with three replicates of a single observation, moving forward the mean of the variable will be used to represent the observation.

The means are calculated of Fmax, ttt and auc from a single patient (patient_number) per visit (clinical_event).

```{r}
# Calculting the means:
means <- tidy_data |>
  group_by(patient_number, clinical_event) |>
  summarise(
    fmax_mean = mean(fmax, na.rm = TRUE),
    ttt_mean  = mean(ttt,  na.rm = TRUE),
    auc_mean  = mean(auc,  na.rm = TRUE),
    .groups = "drop"
  )

# Adding the means to the dataset:
dat_aug <- tidy_data |>
  left_join(means,
            by = c("patient_number", "clinical_event"))

```

## Performing a quality check

When PPMI performed their study, they choose a criteria the Fmax value must meet, for the SAA-result to indicate PD. The indication of PD is stored in the saa_result column as either positive, negative or inconclusive. To ensure they correctly assigned the saa_results to the observations, a quality check is made.

As the two projects differ in method, they used different requirements for each. The requirements used can be seen in the table below:

|              |                                            |
|--------------|--------------------------------------------|
| **Result**   | **Project 155 - Criteria of Fmax**         |
| Positive     | All 3 replicates have Fmax ≥ 5,000 RFU     |
| Negative     | 0 or 1 replicate has Fmax ≥ 5,000 RFU      |
| Inconclusive | Exactly 2 replicates have Fmax ≥ 5,000 RFU |

+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Result       | **Project 237 - Criteria of Fmax**                                                                                                   |
+==============+======================================================================================================================================+
| Positive     | -   All 3 replicates have Fmax ≥ 45,000 RFU                                                                                          |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 2 or 3 replicates have Fmax ≥ 3,000 RFU & \< 45,000 RFU                                                                  |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 2 replicates have Fmax ≥ 45,000 RFU & 1 replicate has Fmax ≥ 3,000 RFU & \< 45,000 RFU                                   |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Negative     | -   0 or 1 replicate has Fmax ≥ 3,000 RFU                                                                                            |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Inconclusive | -   Exactly 2 replicates have Fmax ≥ 45,000 RFU & 1 replicate has Fmax \< 3,000 RFU                                                  |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 1 replicate has Fmax ≥ 45,000 RFU & 1 replicate has Fmax ≥ 3,000 RFU & \< 45,000 RFU & 1 replicate has Fmax \< 3,000 RFU |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+

Prepare replicate vectors for SAA rule

```{r}
reps <- tidy_data |>
  group_by(patient_number, project, duration, clinical_event) |> 
  summarise(
    fmax_reps = list(fmax),
    .groups = "drop"
  )

dat_aug <- dat_aug |> 
  left_join(reps,
            by = c("patient_number", "project", "duration","clinical_event"))
View(reps)
```

We prepare to calculate the status from the fmax values by first creating two functions with the rules:

```{r}
saa_rule_155 <- function(x) {
  x <- unlist(x)
  n_pos <- sum(x >= 5000, na.rm = TRUE)

  case_when(
    n_pos == 3 ~ "Positive",
    n_pos <= 1 ~ "Negative",
    n_pos == 2 ~ "Inconclusive",
    TRUE ~ NA_character_
  )
}

saa_rule_237 <- function(x) {
  x <- unlist(x)

  n_ge_45000 <- sum(x >= 45000, na.rm = TRUE)
  n_ge_3000  <- sum(x >= 3000,  na.rm = TRUE)
  n_between  <- sum(x >= 3000 & x < 45000, na.rm = TRUE)
  n_lt_3000  <- sum(x < 3000, na.rm = TRUE)

  # Positive
  if (n_ge_45000 == 3) return("Positive")
  if (n_between == 2 | n_between == 3) return("Positive")
  if (n_ge_45000 == 2 & n_between == 1) return("Positive")

  # Negative
  if (n_ge_3000 <= 1) return("Negative")

  # Inconclusive
  if (n_ge_45000 == 2 & n_lt_3000 == 1) return("Inconclusive")
  if (n_ge_45000 == 1 & n_between == 1 & n_lt_3000 == 1) return("Inconclusive")

  NA_character_
}
```

\
Applying the functions:

```{r}
dat_aug <- dat_aug |> 
  rowwise() |> 
  mutate(
    saa_custom = case_when(
      project == "155" ~ saa_rule_155(fmax_reps),
      project == "237" ~ saa_rule_237(fmax_reps),
      TRUE ~ NA_character_
    )
  ) %>%
  ungroup()

```

lastly we calculate the days from baseline and remove the generated vector column before saving

```{r}
dat_aug <- dat_aug |> 
  mutate(rundate = as.Date(rundate)) |> 
  group_by(patient_number) |> 
  mutate(days_from_baseline = as.numeric(rundate - min(rundate, na.rm = TRUE))) |> 
  ungroup()

dat_aug <- dat_aug |>  select(-fmax_reps)
```

```{r}
dat_aug <- dat_aug |> 
  mutate(across(c(project, 
                  duration, 
                  rep, 
                  instrument), 
                
                as.character))
```

save the augmented data

```{r}
write_tsv(dat_aug, "../data/03_dat_aug.tsv")
```
