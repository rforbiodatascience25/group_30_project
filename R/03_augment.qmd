---
title: "03_augment"
format: html
---

```{r}
#| message: false

library(tidyverse)
library(here)
library(fs)
```

# Loading the clean data

```{r}
#| message: false

tidy_data <- read_tsv("../data/02_dat_clean.tsv")
```

# Augment Data

## Finding days from baseline

Some patients were tested multiple times at different dates. We calculate the days from baseline and add a colum with this information.

It should be noted that for 2 patients (40771 and 40754) the rundate appears to have been inputted wrong, so that it appears as if several samples were taken on just one day, despite them having different clinical_events. Therefore, it is insufficient to just sort by days_from_baseline, and clinical_events is therefore kept.

```{r}
tidy_data <- tidy_data |> 
  mutate(rundate = as.Date(rundate)) |> 
  group_by(patient_number) |> 
  mutate(days_from_baseline = as.numeric(rundate - min(rundate, na.rm = TRUE))) |> 
  ungroup()

```

## Calculating means of Fmax, ttt and auc

Instead of working with three replicates of a single observation, moving forward the mean of the variable will be used to represent the observation.

The means are calculated of Fmax, ttt and auc from a single patient (patient_number) per visit (clinical_event).

```{r}
means <- tidy_data |>
  group_by(patient_number, clinical_event, days_from_baseline) |>
  summarise(
    fmax_mean = mean(fmax, na.rm = TRUE),
    ttt_mean  = mean(ttt,  na.rm = TRUE),
    auc_mean  = mean(auc,  na.rm = TRUE),
    .groups = "drop"
  )

# Adding the means to the dataset
aug_data <- tidy_data |>
  left_join(means,
            by = c("patient_number", 
                   "clinical_event", 
                   "days_from_baseline"))

```

## Performing a quality check

When PPMI performed their study, they choose a criteria the Fmax value must meet, for the SAA-result to indicate PD. The indication of PD is stored in the saa_result column as either positive, negative or inconclusive. To ensure they correctly assigned the saa_results to the observations, a quality check is made.

As the two projects differ in method, they used different requirements for each. The requirements used can be seen in the table below:

|              |                                            |
|--------------|--------------------------------------------|
| **Result**   | **Project 155 - Criteria of Fmax**         |
| Positive     | All 3 replicates have Fmax ≥ 5,000 RFU     |
| Negative     | 0 or 1 replicate has Fmax ≥ 5,000 RFU      |
| Inconclusive | Exactly 2 replicates have Fmax ≥ 5,000 RFU |

+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Result       | **Project 237 - Criteria of Fmax**                                                                                                   |
+==============+======================================================================================================================================+
| Positive     | -   All 3 replicates have Fmax ≥ 45,000 RFU                                                                                          |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 2 or 3 replicates have Fmax ≥ 3,000 RFU & \< 45,000 RFU                                                                  |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 2 replicates have Fmax ≥ 45,000 RFU & 1 replicate has Fmax ≥ 3,000 RFU & \< 45,000 RFU                                   |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Negative     | -   0 or 1 replicate has Fmax ≥ 3,000 RFU                                                                                            |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+
| Inconclusive | -   Exactly 2 replicates have Fmax ≥ 45,000 RFU & 1 replicate has Fmax \< 3,000 RFU                                                  |
|              |                                                                                                                                      |
|              |     or                                                                                                                               |
|              |                                                                                                                                      |
|              | -   Exactly 1 replicate has Fmax ≥ 45,000 RFU & 1 replicate has Fmax ≥ 3,000 RFU & \< 45,000 RFU & 1 replicate has Fmax \< 3,000 RFU |
+--------------+--------------------------------------------------------------------------------------------------------------------------------------+

Prepare replicate vectors for SAA rule

```{r}
reps <- tidy_data |>
  group_by(patient_number, project, clinical_event, days_from_baseline) |> 
  summarise(
    fmax_reps = list(fmax),
    .groups = "drop"
  )

aug_data <- aug_data |> 
  left_join(reps,
            by = c("patient_number", 
                   "project", 
                   "clinical_event",
                   "days_from_baseline"))
```

We prepare to calculate the status from the fmax values by first creating two functions with the rules:

```{r}
saa_rule_155 <- function(x) {
  x <- unlist(x)
  n_pos <- sum(x >= 5000, na.rm = TRUE)

  case_when(
    n_pos == 3 ~ "Positive",
    n_pos <= 1 ~ "Negative",
    n_pos == 2 ~ "Inconclusive",
    TRUE ~ NA_character_
  )
}

saa_rule_237 <- function(x) {
  x <- unlist(x)

  n_ge_45000 <- sum(x >= 45000, na.rm = TRUE)
  n_ge_3000  <- sum(x >= 3000,  na.rm = TRUE)
  n_between  <- sum(x >= 3000 & x < 45000, na.rm = TRUE)
  n_lt_3000  <- sum(x < 3000, na.rm = TRUE)

  # Positive
  if (n_ge_45000 == 3) return("Positive")
  if (n_between == 2 | n_between == 3) return("Positive")
  if (n_ge_45000 == 2 & n_between == 1) return("Positive")

  # Negative
  if (n_ge_3000 <= 1) return("Negative")

  # Inconclusive
  if (length(x<3)) return("Inconclusive")
  if (n_ge_45000 == 2 & n_lt_3000 == 1) return("Inconclusive")
  if (n_ge_45000 == 1 & n_between == 1 & n_lt_3000 == 1) return("Inconclusive")

  NA_character_
}
```

\
Applying the functions and subsequently removing the generated fmax_reps column.

```{r}
aug_data <- aug_data |> 
  rowwise() |> 
  mutate(
    saa_custom = case_when(
      project == "155" ~ saa_rule_155(fmax_reps),
      project == "237" ~ saa_rule_237(fmax_reps),
      TRUE ~ NA_character_
    )
  ) |> 
  ungroup()

aug_data <- aug_data |>  
  select(-fmax_reps)

```

Declaring datatype in some columns

```{r}
aug_data <- aug_data |> 
  mutate(across(c(project, 
                  duration, 
                  rep, 
                  instrument), 
                
                as.character))
```

## Save the augmented data

```{r}
write_tsv(aug_data, "../data/03_aug_data.tsv")
```

## Moving html files in the right place

```{r}
old_dir <- here("R", "02_augment.html")
new_dir <- here("results", "02_augment.html")
if (file_exists(old_dir)) {
file_move(old_dir, new_dir)
}
```
