---
title: "03_augment"
format: html
---

```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
```

## Load Clean Data

```{r}
saa_data_tidy <- read_tsv("../data/02_dat_clean.tsv")
```

## Augment Data

First we calculate means from the three datapoints of both the 24h & 150h measurements. To do this we first create a function for calculating replicate means:

```{r}
# Computes rowwise mean for a group of 3 replicate columns
replicate_mean <- function(df, prefix) {
  reps <- paste0(prefix, "_Rep", 1:3)

  df %>%
    mutate(across(all_of(reps), as.numeric)) %>%
    mutate("{prefix}_mean" := rowMeans(across(all_of(reps)), na.rm = TRUE))
}

```

\
Then we use the function:

```{r}
saa_data_aug <- saa_data_tidy %>%
  replicate_mean("Fmax_24h") %>%
  replicate_mean("TTT_24h") %>%
  replicate_mean("AUC_24h") %>%
  replicate_mean("TSmax_24h") %>%
  replicate_mean("SLOPEMax_24h") %>%
  replicate_mean("Fmax_150h") %>%
  replicate_mean("TTT_150h") %>%
  replicate_mean("AUC_150h") %>%
  replicate_mean("T50_150h") %>%
  replicate_mean("SLOPE_150h")
```

We calculate the status from the fmax values by first creating two functions with the rules:\

```{r}
saa_rule_155 <- function(Fmax_reps) {
  n_pos <- sum(Fmax_reps >= 5000, na.rm = TRUE)

  case_when(
    n_pos == 3 ~ "Positive",
    n_pos <= 1 ~ "Negative",
    n_pos == 2 ~ "Inconclusive",
    TRUE ~ NA_character_
  )
}


saa_rule_237 <- function(Fmax_reps) {

  n_ge_45000 <- sum(Fmax_reps >= 45000, na.rm = TRUE)
  n_ge_3000  <- sum(Fmax_reps >= 3000,  na.rm = TRUE)
  n_between  <- sum(Fmax_reps >= 3000 & Fmax_reps < 45000, na.rm = TRUE)
  n_lt_3000  <- sum(Fmax_reps < 3000, na.rm = TRUE)

  # Positive conditions
  if (n_ge_45000 == 3) {
    return("Positive")
  }
  if (n_ge_3000 >= 2 & n_ge_45000 <= 1) {
    return("Positive")
  }
  if (n_ge_45000 == 2 & n_between == 1) {
    return("Positive")
  }

  # Negative condition
  if (n_ge_3000 <= 1) {
    return("Negative")
  }

  # Inconclusive conditions
  if (n_ge_45000 == 2 & n_lt_3000 == 1) {
    return("Inconclusive")
  }
  if (n_ge_45000 == 1 & n_between == 1 & n_lt_3000 == 1) {
    return("Inconclusive")
  }

  return(NA_character_)
}

```

\

```{r}
saa_data_aug <- saa_data_aug %>%
  rowwise() %>%
  mutate(
    SAA_status_custom =
      if (PROJECTID == 155) {
        saa_rule_155(c_across(starts_with("Fmax_24h_Rep")))
      } else if (PROJECTID == 237) {
        saa_rule_237(c_across(starts_with("Fmax_24h_Rep")))
      } else {
        NA_character_
      }
  ) %>%
  ungroup()
```

lastly we calculate the days from baseline

```{r}
saa_data_aug <- saa_data_aug %>%
  mutate(RUNDATE = as.Date(RUNDATE)) %>%
  group_by(PATNO) %>%
  mutate(
    baseline_date = min(RUNDATE, na.rm = TRUE),
    days_from_baseline = as.numeric(RUNDATE - baseline_date)
  ) %>%
  ungroup()
```

\
\
save the augmented data

```{r}
write_tsv(saa_data_aug, "../data/03_dat_aug.tsv")
```
